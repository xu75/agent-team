# Agent Team System Architecture | å¤šæ™ºèƒ½ä½“åä½œç³»ç»Ÿæ¶æ„

**Version | ç‰ˆæœ¬**: V0.03
**Last updated | æœ€è¿‘æ›´æ–°**: 2026-02-28
**Status | çŠ¶æ€**: Active (reflects current implementation) | æ´»è·ƒç‰ˆæœ¬ï¼ˆåæ˜ å½“å‰å®ç°ï¼‰
**Scope | èŒƒå›´**: Architecture plan + engineering principles + implementation status | æ¶æ„æ–¹æ¡ˆ + å·¥ç¨‹åŸåˆ™ + å®ç°è¿›åº¦

---

## Changelog | ä¿®æ”¹è®°å½•

- **V0.03 (2026-02-28)**
  - æ–°å¢â€çŒ«çŒ«èŠå¤©æ¨¡å¼â€ï¼ˆChat Sessionï¼‰ï¼š@çŒ«çŒ«è‡ªç”±å¯¹è¯ï¼Œç‹¬ç«‹äºæµæ°´çº¿çš„è½»é‡äº¤äº’é€šé“ã€‚
  - å¤š Provider å·²æå‰è½åœ°ï¼šClaude CLIï¼ˆå« settings_file åˆ‡æ¢ GLM åç«¯ï¼‰ã€Codex CLIã€Gemini CLIï¼ˆplaceholderï¼‰ã€‚
  - é‡Œç¨‹ç¢‘è¿›åº¦åˆ·æ–°ï¼šM1â€“M3 å·²å®Œæˆï¼ŒM4 è¿›è¡Œä¸­ï¼ŒM5 éƒ¨åˆ†æå‰å®Œæˆã€‚
  - æµ‹è¯•é˜¶æ®µå¥å£®æ€§å¢å¼ºï¼šblocked command æ£€æµ‹ã€repeated failure æ£€æµ‹ã€tester prompt æ”¶ç´§ allowlistã€‚
  - è§’è‰²äººæ ¼åŒ–ï¼ˆcats configï¼‰ï¼šæ¯åªçŒ«çŒ«æœ‰ avatarã€colorã€personaï¼Œæ”¯æŒ @mention è·¯ç”±ã€‚
  - é”™è¯¯åˆ†ç±»ç»†åŒ–ï¼šæ–°å¢ `tester_command_blocked`ã€`repeated_test_failure` outcomeã€‚

- **V0.02 (2026-02-15)**
  - æ˜ç¡®ç›®æ ‡é—´ä¼˜å…ˆçº§å†²çªï¼šè¡¥å……â€é˜¶æ®µæ€§èšç„¦â€è¯´æ˜ï¼ˆM1â€“M3 èšç„¦å•æ¨¡å‹å¤šè§’è‰²é—­ç¯ï¼ŒM5 å†å¼•å…¥å¤šæ¨¡å‹ï¼‰ã€‚
  - æ–°å¢æ ¸å¿ƒåŸåˆ™â€å¤±è´¥æ˜¯å¸¸æ€â€ï¼Œå°†å¤±è´¥å¤„ç†æå‡ä¸ºä¸»è·¯å¾„ï¼ˆfirst-class pathï¼‰ã€‚
  - å¼ºåŒ–å·¥ç¨‹åŒ–ä¸å¤æ‚åº¦æ§åˆ¶çš„ç³»ç»Ÿçº§å®šä½ã€‚

- **V0.01 (2026-02-15)**
  - åˆå§‹ç³»ç»Ÿçº§æ¶æ„åŸºçº¿ï¼šåˆ†å±‚ï¼ˆProvider/Engine/Agent/Orchestrator/Persistence/API+Worker/Frontendï¼‰ã€å¤šæ¨¡å‹ç­–ç•¥ã€ç•™ç—•ä¸å¤ç›˜ã€é‡Œç¨‹ç¢‘ã€é£é™©ä¸è¯„å®¡æ¸…å•ã€‚

---

# 0. è®¾è®¡ç›®æ ‡ä¸åŸåˆ™

## ç›®æ ‡

1. **å¤š Agent åä½œç¼–ç¨‹**ï¼šæ¶æ„å¸ˆ/æ ¸å¿ƒå¼€å‘/ä»£ç æ£€è§†&å®‰å…¨/æµ‹è¯•/å‰ç«¯ä½“éªŒ&è§†è§‰/æ–‡æ¡£ä¸æ€»ç»“ç­‰è§’è‰²æ˜ç¡®åˆ†å·¥ã€‚
2. **å…¼å®¹æ¥å…¥ä¸åˆ‡æ¢**ï¼šClaude/Codex/Gemini/æœªæ¥æ›´å¤šæ¨¡å‹ï¼Œç»Ÿä¸€æ¥å£ï¼ŒæŒ‰ä»»åŠ¡/ç­–ç•¥è·¯ç”±ã€‚
3. **å‰åç«¯è§£è€¦**ï¼šåç«¯è´Ÿè´£ç¼–æ’ã€æ‰§è¡Œã€å­˜å‚¨ã€å®¡è®¡ï¼›å‰ç«¯è´Ÿè´£å¯è§†åŒ–ã€äº¤äº’ã€å›æ”¾ã€‚
4. **è¶³å¤Ÿç•™ç—•**ï¼šè¾“å…¥/è¾“å‡º/å†³ç­–/è¡¥ä¸/æµ‹è¯•ç»“æœ/å·¥å…·è°ƒç”¨è½¨è¿¹å¯è¿½æº¯ï¼Œä¾¿äºå®šä½é—®é¢˜ä¸å¤ç›˜ã€‚
5. **æ–‡æ¡£åŒ–ä¸æ”¹è¿›é—­ç¯**ï¼šæŠŠâ€œè¸©å‘â†’ä¿®å¤â†’è§„åˆ™â€å›ºåŒ–æˆ ADR/Runbook/Checklistï¼›æ”¯æŒå¼ºåˆ¶å¤ç›˜æ¨¡æ¿ã€‚

### ä¼˜å…ˆçº§è¯´æ˜ï¼ˆé˜¶æ®µæ€§èšç„¦ï¼‰

ä¸ºé¿å…ç›®æ ‡é—´èµ„æºç«äº‰ï¼š

- **M1â€“M3 å·²å®Œæˆï¼šå•æ¨¡å‹ + å¤šè§’è‰²åä½œé—­ç¯**
  - Orchestrator FSMã€è§’è‰²å¥‘çº¦ã€æµ‹è¯•å›ä¼ ä¸è¿­ä»£æœºåˆ¶å·²ç¨³å®šè¿è¡Œã€‚
  - Coder â†’ Reviewer â†’ Tester æµæ°´çº¿é—­ç¯å·²éªŒè¯ã€‚
- **M4 è¿›è¡Œä¸­ï¼šå‰ç«¯é¢æ¿ + çŒ«çŒ«èŠå¤©æ¨¡å¼**
  - Timeline UIã€chat streamã€role config é¢æ¿å·²ä¸Šçº¿ã€‚
  - æ–°å¢ Chat Session å¼•æ“ï¼Œæ”¯æŒ @çŒ«çŒ« è‡ªç”±å¯¹è¯ã€‚
- **M5 éƒ¨åˆ†æå‰å®Œæˆï¼šå¤š Provider æ¥å…¥**
  - Claude CLIï¼ˆå« --settings åˆ‡æ¢ GLM åç«¯ï¼‰ã€Codex CLI å·²æŠ•äº§ã€‚
  - Gemini CLI placeholder å·²å°±ä½ï¼Œå¾… CLI å·¥å…·æˆç†Ÿåæ¥å…¥ã€‚
  - per-role provider åˆ†é…å·²å®ç°ï¼ˆrole-config.json stage_assignmentï¼‰ã€‚

è¯´æ˜ï¼šç›®æ ‡ 2ï¼ˆå¤šæ¨¡å‹å…¼å®¹ï¼‰å›  settings_file æ–¹æ¡ˆçš„ä½æˆæœ¬ç‰¹æ€§ï¼Œå·²æå‰éƒ¨åˆ†è½åœ°ï¼Œæœªæ˜¾è‘—å¢åŠ ç³»ç»Ÿå¤æ‚åº¦ã€‚

## æ ¸å¿ƒåŸåˆ™

- **è¯šå®ä¼˜å…ˆ**ï¼šä¿¡æ¯ä¸è¶³å¿…é¡»è¯´â€œä¸çŸ¥é“â€ï¼Œé¿å…â€œçœ‹èµ·æ¥å¾ˆä¸“ä¸šä½†åœ¨ç¼–é€ â€çš„å¹»è§‰å¼ç»“è®ºã€‚
- **CLI å·¥ç¨‹åŒ–**ï¼šä¸è¦æŠŠâ€œèƒ½è·‘â€å½“â€œèƒ½ç”¨â€ï¼›stderr æ´»è·ƒã€è¶…æ—¶ã€éš”ç¦»ã€é€€å‡ºç ã€ä¿¡å·å¤„ç†æ˜¯åº•çº¿ã€‚
- **è¯æ®æ ‡æ³¨**ï¼šå…³é”®ç»“è®ºæ ‡æ³¨è¯æ®æ¥æºï¼ˆäº‹å®/æ¨æ–­/å¤–éƒ¨ï¼‰ï¼Œé™ä½â€œå¤ç›˜æ—¶è¯´ä¸æ¸…â€ã€‚
- **ç»“æ„åŒ–è¾“å‡ºä¼˜å…ˆ**ï¼šå°½é‡ç”¨ JSON schema/å›ºå®šæ ¼å¼å¥‘çº¦ï¼Œå‡å°‘è‡ªç”±æ–‡æœ¬å¯¼è‡´çš„ä¸å¯æ§ã€‚
- **æ¨¡å—è¾¹ç•Œä¼˜å…ˆ**ï¼šé€šè¿‡æ¸…æ™°åˆ‡åˆ†é™ä½å¤æ‚åº¦ï¼Œä¾¿äºå®šä½é—®é¢˜ä¸æ‰©å±•èƒ½åŠ›ã€‚
- **å¤±è´¥æ˜¯å¸¸æ€**ï¼šLLM è¾“å‡ºä¸ç¬¦åˆ schemaã€Provider è¶…æ—¶ã€æµ‹è¯•å¤±è´¥ã€æ¨¡å‹åˆ‡æ¢å¼‚å¸¸ç­‰ï¼Œéƒ½ä¸æ˜¯â€œå¼‚å¸¸æƒ…å†µâ€ï¼Œè€Œæ˜¯ç³»ç»Ÿçš„å¸¸è§„è·¯å¾„ã€‚ç³»ç»Ÿè®¾è®¡åº”å°†â€œä¼˜é›…å¤„ç†å¤±è´¥â€ä½œä¸ºä¸»è·¯å¾„ï¼ˆfirst-class pathï¼‰ï¼Œè€Œéå¼‚å¸¸åˆ†æ”¯ã€‚éœ€è¦å†…å»ºé‡è¯•ç­–ç•¥ã€çŠ¶æ€å›æ»šã€å¯æ¢å¤æµç¨‹ä¸æ˜ç¡®çš„å¤±è´¥å¯è§†åŒ–ã€‚

---

# 1. æ€»ä½“æ¶æ„ï¼ˆåˆ†å±‚ + æ¨¡å—åˆ‡åˆ†ï¼‰

ä»ä¸‹åˆ°ä¸Šï¼š

## A. Provider / Runtime å±‚ï¼ˆæœ€åº•å±‚ï¼‰

- è´Ÿè´£â€œæŠŠæ¨¡å‹è·‘èµ·æ¥â€ï¼šClaude CLI / OpenAI / Gemini / APIã€Bedrock/Vertex ç­‰
- æŠ½è±¡æˆç»Ÿä¸€ `ProviderAdapter` æ¥å£

## B. Engine å±‚ï¼ˆå¯å¤ç”¨æ‰§è¡Œå¼•æ“ï¼‰

- è´Ÿè´£ï¼šspawn/æµå¼è§£æ/é”™è¯¯å¤„ç†/è¶…æ—¶/ä¿¡å·/ï¼ˆå¯å¼€å…³ï¼‰é‡è¯•ç­–ç•¥
- äº§å‡ºæ ‡å‡†åŒ–äº‹ä»¶æµï¼š`RunEvent[]`

## C. Agent å±‚ï¼ˆè§’è‰²ä¸æç¤ºè¯æ¨¡æ¿ï¼‰

- æŠŠâ€œæ¨¡å‹èƒ½åŠ›â€åŒ…è£…ä¸ºâ€œè§’è‰²èƒ½åŠ›â€ï¼šArchitectã€CoreDevã€Reviewerã€Securityã€Testerã€FrontendDesignerã€DocWriterâ€¦
- æ¯ä¸ª Agent æœ‰å›ºå®šè¾“å…¥/è¾“å‡ºå¥‘çº¦ï¼ˆSchemaï¼‰

## D. Orchestration å±‚ï¼ˆç¼–æ’å™¨ / åè°ƒå™¨ï¼‰

- è´Ÿè´£å¤šè§’è‰²åä½œï¼šä»»åŠ¡æ‹†åˆ†ã€è·¯ç”±ã€å›åˆæ§åˆ¶ã€å†²çªè§£å†³ã€ç»ˆæ­¢æ¡ä»¶
- å½¢æˆâ€œå·¥ä½œæµ DAGâ€æˆ–â€œæœ‰é™çŠ¶æ€æœº FSMâ€ï¼ˆå»ºè®®å…ˆ FSMï¼Œç®€å•å¯æ§ï¼‰

## E. Persistence / Observability å±‚ï¼ˆç•™ç—•ä¸å›æ”¾ï¼‰

- å­˜å‚¨ï¼šä»»åŠ¡ã€å›åˆã€æç¤ºè¯ã€åŸå§‹ NDJSONã€ç»“æ„åŒ–è¾“å‡ºã€diffã€æµ‹è¯•æŠ¥å‘Š
- å¯è§‚æµ‹ï¼šæ—¥å¿—ã€æŒ‡æ ‡ã€traceã€é‡æ”¾

## F. API / Frontend å±‚ï¼ˆäº§å“åŒ–äº¤äº’ï¼‰

- åç«¯æä¾›ï¼šä»»åŠ¡åˆ›å»ºã€çŠ¶æ€æŸ¥è¯¢ã€å›æ”¾ã€å¯¼å‡ºæŠ¥å‘Šã€æƒé™æ§åˆ¶
- å‰ç«¯æä¾›ï¼šåä½œé¢æ¿ã€diff è§†å›¾ã€æµ‹è¯•è§†å›¾ã€å›åˆå¯¹æ¯”ã€æ¨¡å‹åˆ‡æ¢

> æç¤ºï¼šæŠŠâ€œæ–¹æ³•è®º/å¤ç›˜/è§„åˆ™â€ä¸â€œä»£ç å®ç°â€åˆ†å±‚ç®¡ç†ï¼Œé¿å… README/ä»£ç ä»“é‡Œå †æ»¡ä¸å¯ç»´æŠ¤çš„æµç¨‹è¯´æ˜ã€‚

---

# 2. å…³é”®æ¨¡å—è®¾è®¡ï¼ˆèŒè´£æ¸…æ™°ã€ä¾¿äºå®šä½ï¼‰

## 2.1 ProviderAdapterï¼ˆå¤šæ¨¡å‹å…¼å®¹æ¥å…¥ï¼‰

ç»Ÿä¸€æ¥å£ï¼ˆå»ºè®® TSï¼Œäº¦å¯å…ˆ JSï¼‰ï¼š

- `capabilities()`ï¼šæ”¯æŒçš„æ¨¡å‹/å·¥å…·/æœ€å¤§ä¸Šä¸‹æ–‡/æ˜¯å¦æ”¯æŒ JSON æµ
- `invoke(request) -> AsyncIterable<ProviderEvent>`ï¼šæµå¼è¾“å‡ºï¼ˆæ–‡æœ¬/å·¥å…·äº‹ä»¶/é”™è¯¯/ç»Ÿè®¡ï¼‰
- `healthCheck()`ï¼šå¯ç”¨æ€§ã€é‰´æƒçŠ¶æ€ã€é…é¢çŠ¶æ€
- `normalize(event) -> RunEvent`ï¼šæŠŠå„å®¶äº‹ä»¶è½¬æˆç»Ÿä¸€æ ¼å¼

å·²å®ç°é€‚é…å™¨ï¼š
- `claude-cli`ï¼š`claude -p ... --output-format stream-json --verbose`ï¼Œæ”¯æŒ `--settings` åˆ‡æ¢åç«¯ï¼ˆå¦‚ GLMï¼‰ã€`--model` æŒ‡å®šæ¨¡å‹
- `codex-cli`ï¼š`codex -q --full-auto`ï¼Œçº¯æ–‡æœ¬è¾“å‡ºæ¨¡å¼
- `gemini-cli`ï¼šplaceholderï¼Œ`gemini --model ...`ï¼Œçº¯æ–‡æœ¬è¾“å‡ºæ¨¡å¼

åˆ‡æ¢ç­–ç•¥ï¼ˆå·²å®ç°ï¼‰ï¼š
- `role-config.json` ä¸­ `stage_assignment` æŒ‡å®šæ¯ä¸ªè§’è‰²ä½¿ç”¨å“ªä¸ª model_id
- `models[]` å®šä¹‰ providerã€modelã€settings_file çš„æ˜ å°„
- Coordinator è¿è¡Œæ—¶é€šè¿‡ `roleProviders` è‡ªåŠ¨è·¯ç”±

---

## 2.2 Engineï¼ˆæ‰§è¡Œä¸æµå¼è§£æï¼‰

èŒè´£ï¼šæŠŠ provider è°ƒç”¨å˜æˆç¨³å®šçš„ã€å¯è§‚æµ‹çš„ä»»åŠ¡è¿è¡Œã€‚

Engine è¾“å‡ºç»Ÿä¸€ `RunEvent`ï¼ˆå»ºè®® JSON schemaï¼‰ï¼š
- `run.started`, `run.stdout.line`, `run.stderr.line`, `assistant.delta`, `tool.call`, `tool.result`, `run.completed`, `run.failed`â€¦

æœ€ä½é™åº¦ä¿è¯ï¼š
- stdout/stderr éƒ½è®¡å…¥â€œæ´»è·ƒâ€ï¼Œé¿å…è¯¯åˆ¤è¶…æ—¶
- é€€å‡ºç /ä¿¡å·/å¼‚å¸¸å¯è¿½è¸ª
- åŸå§‹ NDJSON å¯é€‰è½ç›˜ï¼ˆç”¨äºå¤ç›˜ä¸è¯æ®é“¾ï¼‰

---

## 2.3 Agentï¼ˆè§’è‰²èƒ½åŠ›æ¨¡å—ï¼‰

æ¯ä¸ª Agent = `prompt template + output schema + guardrails + post-processor`

å»ºè®®è§’è‰²é›†åˆï¼ˆå¯æ‰©å±•ï¼‰ï¼š
- **Architect**ï¼šæ¨¡å—åˆ’åˆ†ã€æ¥å£å¥‘çº¦ã€æ•°æ®æµã€é£é™©ç‚¹ã€é‡Œç¨‹ç¢‘
- **CoreDev**ï¼šå®ç°æ ¸å¿ƒé€»è¾‘/åè®®/åç«¯æœåŠ¡
- **FrontendDev/Designer**ï¼šäº¤äº’æµç¨‹ã€ç»„ä»¶ä¸è§†è§‰è§„èŒƒ
- **Reviewer**ï¼šä»£ç å®¡æŸ¥ + å¯ç»´æŠ¤æ€§
- **SecurityReviewer**ï¼šå¨èƒå»ºæ¨¡ã€ä¾èµ–/å¯†é’¥/æ³¨å…¥é£é™©
- **Tester**ï¼šæµ‹è¯•è®¡åˆ’ + å•æµ‹/é›†æˆæµ‹è¯•ç”Ÿæˆ + å¤±è´¥å½’å› 
- **DocWriter**ï¼šREADME/Runbook/ADR/å˜æ›´æ—¥å¿—
- **ReleaseManagerï¼ˆåæœŸï¼‰**ï¼šç‰ˆæœ¬ã€è¿ç§»ã€å›æ»šç­–ç•¥

è¾“å‡ºå¥‘çº¦ï¼ˆå¼ºçƒˆå»ºè®®ç»“æ„åŒ–ï¼‰ï¼š
- Reviewerï¼š`must_fix[]`, `nice_to_have[]`, `tests[]`, `security[]`
- Testerï¼š`test_plan`, `test_files_patch`, `commands`, `expected_results`
- Architectï¼š`modules`, `interfaces`, `data_flow`, `risks`, `milestones`

---

## 2.4 Orchestratorï¼ˆåè°ƒå™¨ / å·¥ä½œæµï¼‰

å»ºè®®ç”¨ FSMï¼ˆæœ‰é™çŠ¶æ€æœºï¼‰èµ·æ­¥ï¼š

çŠ¶æ€ç¤ºä¾‹ï¼š
1. `intake`ï¼šæ¥æ”¶éœ€æ±‚ï¼Œç”Ÿæˆ TaskSpec
2. `plan`ï¼šArchitect è¾“å‡ºè®¾è®¡ä¸æ‹†åˆ†
3. `build`ï¼šCoreDev æŒ‰æ¨¡å—å®ç°ï¼ˆå¯åˆ†å­ä»»åŠ¡ï¼‰
4. `review`ï¼šReviewer + SecurityReviewer
5. `test`ï¼šTester ç”Ÿæˆ/è¿è¡Œæµ‹è¯•ï¼ˆCI æˆ–æœ¬åœ°ï¼‰
6. `iterate`ï¼šæ ¹æ® review/test å›åˆ° build
7. `finalize`ï¼šDocWriter æ›´æ–°æ–‡æ¡£ + å¯¼å‡ºæŠ¥å‘Š

ç»ˆæ­¢æ¡ä»¶ï¼š
- must-fix æ¸…é›¶ + æµ‹è¯•é€šè¿‡
- è¾¾åˆ°è¿­ä»£ä¸Šé™ â†’ è¾“å‡ºâ€æœ€ä½³åŠªåŠ› + æœªè§£å†³æ¸…å•â€
- è§¦å‘å®‰å…¨çº¢çº¿ â†’ éœ€è¦äººå·¥å†³ç­–
- blocked command å…¨éƒ¨å¤±è´¥ â†’ åœæ­¢è¿­ä»£ï¼ˆtester é—®é¢˜ï¼Œé coder é—®é¢˜ï¼‰
- è¿ç»­ä¸¤è½®ç›¸åŒæµ‹è¯•å‘½ä»¤å¤±è´¥ â†’ åœæ­¢è¿­ä»£ï¼ˆé¿å…æ­»å¾ªç¯ï¼‰

## 2.5 Chat Session Engineï¼ˆçŒ«çŒ«èŠå¤©å¼•æ“ï¼‰â€” æ–°å¢

ç‹¬ç«‹äºæµæ°´çº¿çš„è½»é‡äº¤äº’é€šé“ï¼Œç”¨äº @çŒ«çŒ« è‡ªç”±å¯¹è¯ã€‚

è®¾è®¡è¦ç‚¹ï¼š
- @mention è§£æï¼šæ”¯æŒ display_nameã€nicknameã€aliases å¤šç§åŒ¹é…
- äººæ ¼åŒ– promptï¼šæ¯åªçŒ«çŒ«æœ‰ç‹¬ç«‹ personaï¼Œå¯¹è¯æ—¶æ³¨å…¥æ€§æ ¼æè¿°å’ŒåŒäº‹å…³ç³»
- å¯¹è¯å†å²ï¼šper-thread JSONL æŒä¹…åŒ–ï¼Œæœ€è¿‘ 20 æ¡ä½œä¸ºä¸Šä¸‹æ–‡çª—å£
- Provider è·¯ç”±ï¼šå¤ç”¨ role-config.json ä¸­ cats â†’ model_id â†’ models çš„æ˜ å°„é“¾
- å¤šçŒ«å¹¶å‘ï¼šåŒæ—¶ @å¤šåªçŒ«çŒ«æ—¶ Promise.all å¹¶è¡Œè°ƒç”¨

æ•°æ®æ¨¡å‹ï¼š
```
logs/threads/<thread-id>/
  meta.json          # { thread_id, title, created_at }
  messages.jsonl     # æ¯è¡Œä¸€æ¡ { id, sender, sender_type, cat_name, text, ts }
```

ä¸æµæ°´çº¿æ¨¡å¼çš„å…³ç³»ï¼š
- èŠå¤©æ¨¡å¼å’Œæµæ°´çº¿æ¨¡å¼äº’æ–¥åˆ‡æ¢ï¼Œå…±äº«åŒä¸€ä¸ª UI composer
- èŠå¤©æ¨¡å¼ä¸èµ° FSMï¼Œä¸äº§ç”Ÿ round/summary
- æœªæ¥å¯è€ƒè™‘ï¼šèŠå¤©ä¸­ /task å‘½ä»¤æ— ç¼åˆ‡æ¢åˆ°æµæ°´çº¿

---

# 3. å‰åç«¯è§£è€¦è®¾è®¡ï¼ˆæ¸…æ™°è´£ä»»ã€ä¾¿äºå®šä½ï¼‰

## 3.1 åç«¯ï¼ˆAPI + Workerï¼‰

å»ºè®®æ‹†æˆä¸¤ä¸ªè¿›ç¨‹ï¼š

**API Serverï¼ˆæ§åˆ¶é¢ï¼‰**
- ä»»åŠ¡åˆ›å»º/æ›´æ–°/å–æ¶ˆ
- è¯»å–è¿è¡Œè®°å½•ã€diffã€æµ‹è¯•æŠ¥å‘Š
- æƒé™ä¸å®¡è®¡æ¥å£
- å¯¼å‡ºå¤ç›˜æŠ¥å‘Šï¼ˆMarkdown/PDFï¼‰

**Worker/Runnerï¼ˆæ•°æ®é¢ï¼‰**
- çœŸæ­£è°ƒç”¨ CLI/API æ‰§è¡Œ
- æ–‡ä»¶è¡¥ä¸åº”ç”¨ï¼ˆå»ºè®® git worktree/ä¸´æ—¶åˆ†æ”¯ï¼‰
- è¿è¡Œæµ‹è¯•/é™æ€æ£€æŸ¥
- äº‹ä»¶æŒä¹…åŒ–ï¼ˆäº‹ä»¶æº¯æºï¼‰

å¥½å¤„ï¼š
- UI/æ§åˆ¶é¢ç¨³å®šï¼›è¿è¡Œé¢å¯æ¨ªå‘æ‰©å±•
- å•ä¸ª provider/èŠ‚ç‚¹å¼‚å¸¸ä¸å½±å“å›æ”¾ä¸å®¡è®¡

## 3.2 å‰ç«¯ï¼ˆå¯è§†åŒ–ä¸åä½œä½“éªŒï¼‰

æ ¸å¿ƒé¡µé¢å»ºè®®ï¼š
- **Task Timeline**ï¼šæ¯å›åˆè¾“å…¥/è¾“å‡º/å†³ç­–ç‚¹
- **Diff Viewer**ï¼špatch/diff å®šä½åˆ°æ–‡ä»¶/è¡Œ
- **Test Panel**ï¼šæµ‹è¯•å‘½ä»¤ã€ç»“æœã€å¤±è´¥æ ˆ
- **Agent Switchboard**ï¼šè§’è‰²â†’æ¨¡å‹ç»‘å®šã€ç‰ˆæœ¬ã€ç­–ç•¥
- **Replay**ï¼šæŒ‰äº‹ä»¶æµå›æ”¾ï¼ˆå®šä½åˆ° stderr/å·¥å…·è°ƒç”¨ï¼‰

---

# 4. ç•™ç—•ä¸å¯å¤ç›˜ï¼ˆâ€œè¯æ®é“¾â€ä¸€ç­‰å…¬æ°‘ï¼‰

## 4.1 äº‹ä»¶æº¯æº + ç‰©åŒ–å¿«ç…§

- **Event Storeï¼ˆè¿½åŠ å†™ï¼‰**ï¼šæ¯ä¸ª `RunEvent` ä¸€æ¡ï¼ˆJSONLï¼‰
- **Materialized Views**ï¼šä»»åŠ¡è¡¨ã€å›åˆè¡¨ã€æœ€æ–°çŠ¶æ€ã€ç»Ÿè®¡æŒ‡æ ‡

## 4.2 æœ€å°è½ç›˜ç»“æ„ï¼ˆäººç±»å¯è¯» + æœºå™¨å¯æŸ¥ï¼‰

```
logs/YYYY-MM-DD/task-<id>/
  task.md
  plan.md
  rounds/
    01/
      coder.md
      reviewer.json
      security.json
      tester.md
      raw.ndjson          # å¯é€‰ï¼šåŸå§‹æµ
      diff.patch
      test-results.txt
    02/...
  summary.md             # æœ€ç»ˆæ€»ç»“ + æœªè§£å†³æ¸…å•
```

## 4.3 å…³é”®å¯è§‚æµ‹æŒ‡æ ‡

- æ¯è§’è‰²è€—æ—¶ã€token/è´¹ç”¨ï¼ˆè‹¥å¯å¾—ï¼‰
- æ¯å›åˆå˜æ›´è¡Œæ•°ã€æ–‡ä»¶æ•°
- æµ‹è¯•é€šè¿‡ç‡ä¸å¤±è´¥ç±»å‹åˆ†å¸ƒ
- å›æ»š/é‡è¯•æ¬¡æ•°
- æ¨¡å‹åˆ‡æ¢æ¬¡æ•°ï¼ˆè¯„ä¼°ç¨³å®šæ€§ï¼‰

---

# 5. æ¨¡å—åŒ–å¼€å‘è·¯çº¿ï¼ˆé™ä½å¤æ‚åº¦çš„é‡Œç¨‹ç¢‘ï¼‰

Milestone 1ï¼šå•æ¨¡å‹ + å•è§’è‰²ï¼ˆMVPï¼‰âœ… å·²å®Œæˆ
- `ClaudeCliAdapter + Engine`
- CoreDevï¼šæµå¼è¾“å‡ºã€ä¿å­˜ logsã€è¾“å‡ºè¡¥ä¸

Milestone 2ï¼šä¸¤è§’è‰²é—­ç¯ï¼ˆCoder + Reviewerï¼‰âœ… å·²å®Œæˆ
- Reviewer è¾“å‡ºç»“æ„åŒ– JSONï¼ˆmust_fix ç­‰ï¼‰
- Coordinator æ‰§è¡Œ 1â€“3 è½®è¿­ä»£
- FSM çŠ¶æ€æœºé©±åŠ¨ï¼ˆintake â†’ plan â†’ build â†’ review â†’ iterate â†’ finalizeï¼‰

Milestone 3ï¼šåŠ å…¥ Testerï¼ˆè´¨é‡é—¨æ§›ï¼‰âœ… å·²å®Œæˆ
- Tester è¾“å‡ºç»“æ„åŒ– JSONï¼ˆtest_plan + commandsï¼‰
- Allowlist runner æ‰§è¡Œæµ‹è¯•å‘½ä»¤
- å¤±è´¥è‡ªåŠ¨å›ä¼ åˆ° Coderï¼ˆå¸¦ stderr snippetï¼‰
- Blocked command æ£€æµ‹ + repeated failure æ£€æµ‹

Milestone 4ï¼šå‰ç«¯é¢æ¿ + çŒ«çŒ«èŠå¤©æ¨¡å¼ ğŸ”§ è¿›è¡Œä¸­
- Timeline + Chat Stream + Role Config é¢æ¿å·²ä¸Šçº¿
- æ–°å¢ Chat Session å¼•æ“ï¼ˆ@çŒ«çŒ« è‡ªç”±å¯¹è¯ï¼‰
- å¾…å®Œæˆï¼šDiff Viewerã€Test Panelã€Replay å›æ”¾
- å¾…å®Œæˆï¼šèŠå¤©å†å² thread åˆ—è¡¨ UI

Milestone 5ï¼šå¤š Provider + ç­–ç•¥è·¯ç”± âš¡ éƒ¨åˆ†æå‰å®Œæˆ
- Claude CLIï¼ˆå« --settings åˆ‡æ¢ GLMï¼‰ã€Codex CLI å·²æŠ•äº§
- Gemini CLI placeholder å·²å°±ä½
- per-role åˆ†é…å·²å®ç°
- å¾…å®Œæˆï¼šfallback ç­–ç•¥ï¼ˆprovider ä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢ï¼‰
- å¾…å®Œæˆï¼šæˆæœ¬/è´¨é‡/é€Ÿåº¦ç­–ç•¥è·¯ç”±

Milestone 6ï¼šç”Ÿäº§åŒ–ï¼ˆéš”ç¦»ä¸å¯é æ€§ï¼‰ğŸ“‹ å¾…å¯åŠ¨
- worktree/ä¸´æ—¶åˆ†æ”¯éš”ç¦»
- secrets hygieneã€æƒé™æœ€å°åŒ–
- å¤±è´¥é™çº§ç­–ç•¥ï¼ˆprovider ä¸å¯ç”¨æ—¶æ›¿æ¢ï¼‰
- é‡è¯•ç­–ç•¥ï¼ˆbackoff + jitterï¼Œå‚è§ error-handling-matrix.mdï¼‰

---

# 6. æ–‡æ¡£ä½“ç³»ä¸â€œæ€»ç»“åæ€æ”¹è¿›â€æœºåˆ¶

## 6.1 æ–‡æ¡£åˆ†ç±»

- `docs/architecture/`ï¼šç³»ç»Ÿæ¶æ„ã€è§’è‰²å¥‘çº¦ã€æ•°æ®æµ
- `docs/runbook/`ï¼šéƒ¨ç½²/æ•…éšœæ’æŸ¥/å¸¸è§é”™è¯¯ï¼ˆstderrã€è¶…æ—¶ã€é‰´æƒç­‰ï¼‰
- `docs/adr/`ï¼šå…³é”®å†³ç­–è®°å½•ï¼ˆä¸ºä»€ä¹ˆè¿™ä¹ˆåš/ä¸è¿™ä¹ˆåšï¼‰
- `docs/postmortems/`ï¼šäº‹æ•…å¤ç›˜ï¼ˆæ—¶é—´çº¿ã€æ ¹å› ã€ä¿®å¤ã€é¢„é˜²ï¼‰
- `docs/prompts/`ï¼šè§’è‰²æç¤ºè¯ç‰ˆæœ¬ï¼ˆå˜æ›´ç•™å†å²ï¼‰

## 6.2 å¤ç›˜æ¨¡æ¿ï¼ˆæ¯ä¸ª task å¯é€‰ï¼‰

- What we wanted
- What happened
- Evidence (raw logs/diff/test)
- Root cause
- Fix & Prevention
- Prompt/Policy changesï¼ˆä¾‹å¦‚æ–°å¢â€œè¯šå®è§„åˆ™â€ï¼‰

---

# 7. é£é™©ç‚¹ä¸å¯¹ç­–ï¼ˆç»™ Reviewer AI çš„â€æŒ‘åˆºå…¥å£â€ï¼‰

1. **æç¤ºè¯æ¼‚ç§»**ï¼šè§’è‰²è¾“å‡ºæ ¼å¼ä¸ç¨³å®š â†’ schema éªŒè¯ + è‡ªåŠ¨çº å
2. **å¹»è§‰å‹ç»“è®º**ï¼šçœ‹ä¼¼ä¸“ä¸šä½†æ— è¯æ® â†’ å¼ºåˆ¶å¼•ç”¨ logs/diff/test ä½œä¸ºè¯æ®é“¾
3. **æ¨¡å‹å·®å¼‚**ï¼šåŒä¸€è§’è‰²æ¢æ¨¡å‹è¡¨ç°ä¸åŒ â†’ Provider æŠ½è±¡ + è®°å½•æ¨¡å‹/ç‰ˆæœ¬/å‚æ•°
4. **å®šä½å›°éš¾**ï¼šæ²¡æœ‰åŸå§‹æµ/æ²¡æœ‰ diff â†’ äº‹ä»¶æº¯æº + æ¯å›åˆå›ºå®šè½ç›˜
5. **å®‰å…¨é£é™©**ï¼šå¯†é’¥æ³„éœ²/è¶Šæƒå†™æ–‡ä»¶ â†’ æœ€å°æƒé™ã€è¾“å‡ºè¿‡æ»¤ã€å®¡è®¡ä¸ secrets æ‰«æ
6. **Tester ç”Ÿæˆéæ³•å‘½ä»¤**ï¼šTester è¾“å‡º allowlist ä¹‹å¤–çš„å‘½ä»¤ â†’ blocked command æ£€æµ‹ + ç›´æ¥ç»ˆæ­¢ï¼ˆå·²å®ç°ï¼‰
7. **æµ‹è¯•æ­»å¾ªç¯**ï¼šç›¸åŒå‘½ä»¤è¿ç»­å¤±è´¥ â†’ repeated failure æ£€æµ‹ + è‡ªåŠ¨åœæ­¢ï¼ˆå·²å®ç°ï¼‰
8. **èŠå¤©æ¨¡å¼äººæ ¼ä¸€è‡´æ€§**ï¼šä¸åŒ provider å¯¹ persona prompt çš„éµä»åº¦ä¸åŒ â†’ éœ€è¦ per-provider è°ƒä¼˜ persona æ¨¡æ¿
9. **settings_file è·¯å¾„å®‰å…¨**ï¼šç”¨æˆ·å¯é…ç½®ä»»æ„ settings æ–‡ä»¶ â†’ expandHome ä»…å¤„ç† `~/`ï¼Œéœ€é˜²æ­¢è·¯å¾„ç©¿è¶Š

---

# 8. æ¶æ„è¯„å®¡ Checklistï¼ˆäº¤ç»™å…¶ä»– AI Reviewï¼‰

- åˆ†å±‚æ˜¯å¦æ¸…æ™°ï¼ŸProvider/Engine/Agent/Orchestrator/Storage/UI æ˜¯å¦èŒè´£æ˜ç¡®ï¼Ÿ
- æ˜¯å¦æ”¯æŒ per-role æ¨¡å‹åˆ‡æ¢ä¸ fallbackï¼Ÿ
- æ˜¯å¦æœ‰è¯æ®é“¾ï¼šraw streamã€diffã€æµ‹è¯•ã€å†³ç­–è®°å½•ï¼Ÿ
- æ˜¯å¦å¯¹æŠ—å¹»è§‰ï¼šè¯šå®è§„åˆ™ã€è¯æ®å¼•ç”¨ã€schema éªŒè¯ï¼Ÿ
- å‰åç«¯è¾¹ç•Œæ˜¯å¦æ¸…æ¥šï¼ŸAPI vs Worker çš„åˆ†ç¦»æ˜¯å¦åˆç†ï¼Ÿ
- é‡Œç¨‹ç¢‘æ˜¯å¦èƒ½é€æ­¥è½åœ°ï¼ˆMVPâ†’é—­ç¯â†’æµ‹è¯•â†’å‰ç«¯â†’å¤šæ¨¡å‹â†’ç”Ÿäº§åŒ–ï¼‰ï¼Ÿ
- æ–‡æ¡£ä½“ç³»æ˜¯å¦èƒ½æ”¯æ’‘é•¿æœŸè¿­ä»£ä¸å¤ç›˜ï¼Ÿ

---

**This document defines the baseline architecture for the Agent Team system.**  
æœ¬æ–‡ä»¶å®šä¹‰å¤šæ™ºèƒ½ä½“åä½œç³»ç»Ÿçš„æ¶æ„åŸºçº¿ã€‚